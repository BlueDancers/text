# ä½¿ç”¨gitlabCI/CDå®Œæˆå‰ç«¯è‡ªåŠ¨åŒ–éƒ¨ç½²

<img src="https://images.591wsh.com/2021/10/18/thumb_1634553431259.png" style="zoom:20%;" />

2021å¹´11æœˆ16æ—¥æ›´æ–° 

- é™æ€æ•°æ®æå–ä¸ºå˜é‡

- å¢åŠ å¤‡ä»½ç‰ˆæœ¬



## å‰è¨€

ä¸ºä»€ä¹ˆä½¿ç”¨CI/CDï¼Ÿ

â€‹	ç›®å‰æˆ‘ä»¬å…¬å¸æ›´æ–°ä½¿ç”¨çš„[è½»é‡åŒ–æ›´æ–°è„šæœ¬](https://juejin.cn/post/7020322286565589029)ï¼Œæ›´æ–°æ“ä½œè™½ç„¶ç®€å•,ä½†æ˜¯ä¸å¤Ÿè§„èŒƒï¼Œå¹¶ä¸”æ•æ„Ÿä¿¡æ¯å­˜åœ¨å¼€å‘è€…ç”µè„‘ä¸­ï¼Œè™½ç„¶æˆ‘ä»¬`git`ä¸Šè¿›è¡Œäº†é…ç½®æ–‡ä»¶å¿½ç•¥ï¼Œä½†æ˜¯ä¾æ—§å­˜åœ¨æ³„å¯†çš„é£é™©ï¼Œä¸ºäº†é˜²æ­¢ä»¥ä¸Šæƒ…å†µå‡ºç°ï¼Œæˆ‘ä»¬å°†æ•æ„Ÿä¿¡æ¯ç§»æ¤åˆ°gitlabä¸­ï¼Œå¹¶ä¸”å°†æ›´æ–°æ“ä½œä»äººå·¥å˜ä¸ºè‡ªåŠ¨åŒ–



## CI/CDçš„ä¼˜ç‚¹

è‡ªåŠ¨æ„å»ºå¹¶ä¸”çŠ¶æ€æ˜¯æ¯ä¸ªäººéƒ½å¯è§çš„

å‡å°‘æ‰‹å·¥çš„é”™è¯¯ï¼Œè§£æ”¾äº†é‡å¤åŠ³åŠ¨åŠ›

æ›´å¥½ï¼Œæ›´å¿«ï¼Œæ›´åŠ å®‰å…¨ï¼Œæ›´åŠ ç¨³å®šçš„äº¤ä»˜

- åœ¨CIçš„è¿‡ç¨‹ä¸­å¯ä»¥è¿›è¡Œä»£ç è´¨é‡çš„è‡ªåŠ¨æ£€æµ‹ï¼Œå‡å°‘äººå·¥æ£€æŸ¥çš„åŠ³åŠ¨åŠ›
- æ‰“åŒ…ç¯å¢ƒä¸€è‡´ï¼Œä¸ä¼šå‡ºç°ç¼–è¯‘åä»£ç å¼‚å¸¸

å‡å°‘ç­‰å¾…æ—¶é—´ï¼Œæ›´å¿«çš„äº¤ä»˜æˆæœ



## å‰ç½®æ¦‚å¿µ

#### CI

â€‹		æŒç»­é›†æˆï¼ˆcontinuous Integrationï¼‰é¢‘ç¹çš„å°†ä»£ç ç»§æ‰¿åˆ°ä¸»å¹²ã€‚ç›®çš„æ˜¯è®©äº§å“å¯ä»¥å¿«é€Ÿè¿­ä»£ï¼ŒåŒæ—¶è¿˜èƒ½ä¿è¯é«˜è´¨é‡ï¼Œä»–çš„æ ¸å¿ƒæªæ–½å°±æ˜¯ä»£ç ç»§æ‰¿åˆ°ä¸»å¹²ä¹‹å‰ï¼Œå¿…é¡»é€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œåªæœ‰å­˜åœ¨å¤±è´¥ï¼Œå°±ä¸èƒ½é›†æˆã€‚"æŒç»­ç»§æ‰¿å¹¶ä¸èƒ½æ¶ˆé™¤bugï¼Œè€Œæ˜¯è®©ä»–éå¸¸å®¹æ˜“å‘ç°å’Œä¿®æ”¹"

#### CD

â€‹		æŒç»­äº¤ä»˜ï¼ˆcontinuous Deliveryï¼‰ä¸æŒç»­éƒ¨ç½²ï¼ˆcontinuous Deploymentï¼‰é¢‘ç¹çš„å°†è½¯ä»¶çš„æ–°ç‰ˆæœ¬ï¼Œäº¤ä»˜ç»™è´¨é‡å›¢é˜Ÿæˆ–è€…ç”¨æˆ·ï¼Œä»¥ä¾›è¯„å®¡ã€‚å¦‚æœè¯„å®¡é€šè¿‡å°±ä¼šè¿›å…¥ç”Ÿäº§é˜¶æ®µï¼ŒæŒç»­äº¤ä»˜å¯ä»¥çœ‹åšæŒç»­é›†æˆçš„ä¸‹ä¸€æ­¥ï¼Œå®ƒå¼ºè°ƒçš„æ˜¯ä¸è®ºæ€ä¹ˆæ›´æ–°ï¼Œè½¯ä»¶éƒ½æ˜¯éšæ—¶éšåœ°å¯ä»¥äº¤ä»˜çš„ï¼›ä»£ç é€šè¿‡è¯„å®¡ä¹‹åï¼Œè‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ŒæŒç»­éƒ¨ç½²æ˜¯æŒç»­äº¤ä»˜çš„ä¸‹ä¸€æ­¥ï¼ŒæŒç»­éƒ¨ç½²çš„ç›®æ ‡æ˜¯ï¼Œè½¯ä»¶åœ¨ä»»ä½•æ—¶åˆ»éƒ½æ˜¯å¯ä»¥éƒ¨ç½²çš„ï¼Œå¯ä»¥è¿›å…¥ç”Ÿäº§é˜¶æ®µ



#### gitLab

â€‹		gitLabæ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨ç¨‹åºï¼Œä»–å¯ä»¥å®ç°ç§æœ‰åŒ–çš„Gtié¡¹ç›®ä»“åº“ï¼Œå¯ä»¥é€šè¿‡webç•Œé¢è¿›è¡Œè®¿é—®å…¬å¼€æˆ–è€…ç§äººé¡¹ç›®



#### gitLab CI/CD

â€‹	gitLabæŒç»­é›†æˆï¼Œåªè¦åœ¨ä»“åº“çš„æ ¹ç›®å½•æ·»åŠ `.gitlab-ci.yml`æ–‡ä»¶ï¼Œå¹¶ä¸”é…ç½®äº†gitLab runnerï¼ˆè¿è¡Œå™¨ï¼‰ï¼Œæ¯æ¬¡ä»£ç å‘ç”Ÿå˜æˆçš„æ—¶å€™å°±ä¼šæ‰§è¡Œ`.gitlab-ci.yml`ä¸­çš„é…ç½®



#### gitLab Runner

â€‹	gitLab Runneræ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæ”¯æŒå¤šå¹³å°è¿è¡Œï¼Œä»–çš„ä½œç”¨æ˜¯æ¯æ¬¡ä»£ç å‘ç”Ÿå˜æ›´çš„æ—¶å€™gitlab CIä¼šæ ¹æ®`.gitlab-ci.yml`ï¼Œé…ç½®æ–‡ä»¶æ‰§è¡Œæµæ°´çº¿ï¼ˆPipelineï¼‰ä¸­æ¯ä¸ªé˜¶æ®µStagesä¸­çš„Jobsï¼Œå¹¶å°†ç»“æœå‘é€å›gitLabã€‚gitLab Runneræ˜¯åŸºäºgitLab CIçš„APIè¿›è¡Œæ„å»ºçš„ç›¸äº’éš”ç¦»çš„æœºå™¨ï¼Œæ‰€ä»¥gitLab Runner ä¸gitlabæœ¬èº«ä¸éœ€è¦å®‰è£…åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå¹¶ä¸”è€ƒè™‘åˆ°æ‰§è¡ŒRunnerå¯¹èµ„æºçš„æ¶ˆè€—ï¼Œä»¥åŠå®‰å…¨æ€§é—®é¢˜ï¼Œæ‰€ä»¥å¹¶ä¸å»ºè®®å®‰è£…åœ¨åŒä¸€å°æœºå™¨ä¸Š



#### Pipelines

â€‹	æµæ°´çº¿ï¼Œæ˜¯åˆ†é˜¶æ®µçš„æ„å»ºä»»åŠ¡ï¼Œæ¯”å¦‚å®‰è£…ä¾èµ–ï¼Œè¿è¡Œæµ‹è¯•ï¼Œæ‰“åŒ…éƒ¨ç½²ï¼Œæµæ°´çº¿ç”±gitLab Runnerè¿›è¡Œè§¦å‘ï¼Œæµæ°´çº¿è¿è¡Œçš„ä¾æ®æ˜¯`gitlab-ci.yml`



#### Stages

â€‹		æ„å»ºé˜¶æ®µ,ä¹Ÿå°±æ˜¯æµæ°´çº¿çš„æ¯ä¸€ä¸ªç¯èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Pipelinesä¸­å»ºç«‹å¤šä¸ªStagesï¼Œæ‰€æœ‰Stageséƒ½ä¼šæŒ‰é¡ºåºåŒæ­¥è¿›è¡Œï¼Œåªæœ‰å½“æ‰€æœ‰çš„Stageséƒ½å®Œæˆäº†Pipelinesæ‰ç®—æˆåŠŸï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸Šä¸€ä¸ªStageså¤±è´¥ï¼Œè¿™æ¡æµæ°´çº¿åˆ™ä¸ºå¤±è´¥



#### Jobs

â€‹	è¡¨ç¤ºæ„å»ºé˜¶æ®µçš„ä½œä¸šï¼Œå…³äºjobsçš„è®¾ç½®æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚æŒ‡å®šæ‰‹åŠ¨è§¦å‘ï¼ŒæŒ‡å®šåˆ†æ”¯è§¦å‘ï¼ŒåŒæ—¶è¿è¡Œå¤šä¸ªjobsï¼Œç­‰ç­‰ï¼Œç›¸åŒçš„Stagesä¸­çš„jobsä¼šå¼‚æ­¥è¿›è¡Œï¼ŒStagesä¸­çš„jobså…¨éƒ¨æˆåŠŸäº†ï¼ŒStagesæ‰ä¸ºæˆåŠŸï¼Œé»˜è®¤æƒ…å†µä¸‹å­˜åœ¨jobså¤±è´¥ï¼Œè¿™æ¡æµæ°´çº¿åˆ™ä¸ºå¤±è´¥



####  .gitlab-ci.yml

â€‹		åœ¨gitLab CI/CDä¸­ï¼Œå…·ä½“å¦‚ä½•è¿è¡Œæµæ°´çº¿ï¼Œæ˜¯ç”±` .gitlab-ci.yml`æ¥ç®¡ç†çš„ï¼Œè¿™ä¸ªæ–‡ä»¶æ”¾åœ¨é¡¹ç›®ä»“åº“çš„æ ¹ç›®å½•

å®ä¾‹ä»£ç ï¼š

````yaml
# stagesï¼šå®šä¹‰Pipelineä¸­çš„å„ä¸ªæ„å»ºé˜¶æ®µï¼Œå¹¶ä¸”å®šä¹‰Stagesåç§°
stages:
  - install
  - build

# å®šä¹‰ install é˜¶æ®µçš„ä¸€ä¸ª job
install-job:
  stage: install
  script:
    - echo "hello install"

# å®šä¹‰ build é˜¶æ®µçš„ä¸€ä¸ª job
build-job:
  stage: build
  script:
    - echo "Hello, build"
````



## ç¯å¢ƒæ­å»º

â€‹	æ­¤ç±»æ–‡ç« å¤ªå¤šäº†ï¼Œè¯·è‡ªè¡ŒæŸ¥æ‰¾ï¼Œæœ¬æ–‡ä¸åšæ­å»ºä»‹ç»

â€‹	é’ˆå¯¹å·²ç»æ­å»ºå¥½çš„gitLabä»¥åŠrunnerï¼Œä¸ºäº†é€‚åº”å‰ç«¯å¼€å‘ç¯å¢ƒï¼Œéœ€è¦å®‰è£…äº†nodeï¼Œcnpmï¼Œç­‰ç­‰ä¾èµ–



## å‰ç½®æŠ€èƒ½

gitï¼šä¸ä¼šgitå¯ä»¥é€€å‡ºç›´æ’­é—´äº†ï¼Œèµ¶å¿«å»å­¦å§

linuxï¼šå¸¸ç”¨å‘½ä»¤å¿…é¡»ä¼šï¼Œä¸ç„¶é…ç½®runnerï¼Œä»¥åŠç¼–å†™ci.ymlè„šæœ¬çš„æ—¶å€™ä¼šå¯¸æ­¥éš¾è¡Œ



## åˆ›å»ºç»„ç»‡ï¼Œå¯¼å…¥gitçš„é¡¹ç›®

> åˆ›å»ºç»„ç»‡ä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿é…ç½®CI/CDçš„å…¨å±€å˜é‡ï¼Œä¹Ÿæ–¹ä¾¿é¡¹ç›®çš„é›†ä¸­ç®¡ç†

â€‹	åœ¨ä½¿ç”¨gitlabä¹‹å‰ï¼Œæˆ‘ä»¬çš„é¡¹ç›®å¯èƒ½ä¼šåœ¨githubï¼Œgiteeï¼Œç­‰ç­‰å…¶ä»–ä»£ç ä»“åº“ï¼Œä¸ºäº†ä¿ç•™ä¹‹å‰è®°å½•ï¼Œæˆ‘ä»¬éœ€è¦å°†gitä»“åº“ç§»æ¤è¿‡æ¥

![image-20211014140909840](https://images.591wsh.com/2021/10/14/1634192962342.png)

æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„æ˜¯giteeï¼Œgitlabæ²¡æœ‰å¯¹æ­¤åšå¿«æ·æ”¯æŒï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨`Repo URL`,å¡«å†™å¥½åœ°å€ä¸è´¦å·ï¼Œå°±å¯ä»¥å°†gitä»“åº“å¯¼å…¥è¿›æ¥

## æ›´æ–°gitæ–‡ä»¶

æˆ‘ä»¬å°†gitè¿ç§»åˆ°gitlabä¹‹åï¼Œç°æœ‰é¡¹ç›®ä¸­çš„.gitæ–‡ä»¶éƒ½éœ€è¦è¿›è¡Œæ›´æ¢ï¼Œä¸èƒ½å†å‘ä¹‹å‰çš„ä»“åº“æäº¤ä»£ç ã€‚

- åœæ­¢ä»£ç æäº¤

- è·å–æœ€æ–°ä»£ç ï¼Œåˆ‡æ¢åˆ°masteråˆ†æ”¯
- clone æ–°çš„gitlabçš„ä»“åº“
- è·å–æ–°çš„.gitæ–‡ä»¶ï¼Œè¦†ç›–åŸæœ¬é¡¹ç›®ä¸­çš„.gitï¼Œå®Œæˆè¿ç§»



åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®Œæˆgité¡¹ç›®çš„è¿ç§»æ“ä½œ

## é…ç½®ç»„ç»‡çš„CI/CDå˜é‡

â€‹	ç»„ç»‡ä¸­çš„é¡¹ç›®å¤§éƒ¨åˆ†éƒ½æ˜¯æ›´æ–°åˆ°ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¾‹å¦‚æœåŠ¡å™¨åœ°å€ä¸å¯†ç ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™éƒ¨åˆ†æ•°æ®ç»Ÿä¸€é…ç½®åˆ°å…¨å±€å˜é‡ï¼Œè¿™æ ·ç»„ç»‡ä¸­çš„é¡¹ç›®åˆ™æ— éœ€å†æ¬¡è¿›è¡Œè®¾ç½®

![image-20211014140044915](https://images.591wsh.com/2021/10/14/thumb_1634191321809.png)

æ³¨æ„ï¼š

- å› ä¸ºæˆ‘ä»¬çš„é¡¹ç›®ä¸ä»…ä»…æ˜¯masteråˆ†æ”¯ä¼šè¿è¡Œrunnerï¼Œå¦‚æœè¿™é‡Œä¸å…³é—­Stateï¼Œé™¤äº†masterï¼ˆå—ä¿æŠ¤çš„åˆ†æ”¯ï¼‰å…¶ä»–çš„åˆ†æ”¯éƒ½è®¿é—®ä¸äº†è¿™ä¸ªå˜é‡
- CI/CDçš„å˜é‡åŠŸèƒ½å¯ä»¥å¾ˆå¥½çš„ä¿æŠ¤é¡¹ç›®çš„éšç§æ•°æ®ï¼Œå¯ä»¥éš”ç¦»ä½¿ç”¨è€…ä¸é¡¹ç›®æ›´æ–°é…ç½®

## é…ç½®gitlab-runnerï¼ˆlinuxï¼‰

> æ³¨æ„ï¼šæœ¬æ–‡æ— æ­å»ºgitlabä»¥åŠgitlab-runnerç›¸å…³æ•™ç¨‹ï¼Œä¸€åˆ‡éƒ½æ˜¯åœ¨å·²ç»æ­å»ºå®Œæˆçš„åŸºç¡€ä¸Šè¿›è¡Œä½¿ç”¨çš„

â€‹	æˆ‘ä»¬é’ˆå¯¹é¡¹ç›®å°±è¦æ³¨å†Œä¸€ä¸ªrunnerï¼Œæ¥å®Œæˆæˆ‘ä»¬æ¥ä¸‹æ¥é…ç½®ä¸­çš„å‘½ä»¤æ“ä½œï¼Œè¿™éƒ¨åˆ†ç•Œé¢æ“ä½œæ— æ³•å®Œæˆï¼Œéœ€è¦å¯¹gitlab runnerçš„æœåŠ¡å™¨è¿›è¡Œæ“ä½œ

### è·å–é…ç½®ç›¸å…³æ•°æ®

![](https://images.591wsh.com/2021/10/14/1634192961446.png)

![](https://images.591wsh.com/2021/10/14/thumb_1634192960394.png)



### æ³¨å†Œè‡ªå®šä¹‰runner

æˆ‘ä»¬éœ€è¦æ³¨å†Œä¸€ä¸ªç‰¹å®šçš„runnerï¼Œè¿™é‡Œå®˜æ–¹æç¤ºé¡ºåºä¸º

1. å®‰è£…runner
2. æ³¨å†Œä¸€ä¸ªrunnerï¼Œå¹¶ä¸”URLæŒ‡å®šä¸ºxxxï¼ŒtokenæŒ‡å®šä¸ºxxx

æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å»runnerå®¿ä¸»æœºä¸Šé¢æ³¨å†Œ

ä½¿ç”¨ç»ˆç«¯å·¥å…·é“¾æ¥å®¿ä¸»æœº

è¾“å…¥å‘½ä»¤

```bash
gitlab-runner register
```

![](https://images.591wsh.com/2021/10/14/thumb_1634195014873.png)

å®Œæˆé…ç½®ä¹‹åï¼Œåœ¨å›åˆ°é¡¹ç›®CI/CDéƒ¨åˆ†çš„è®¾ç½®,å°±ä¼šå‘ç°ä¸‹é¢å¤šä¸€ä¸ªrunner

> æ³¨ï¼šåˆšåˆšæ³¨å†Œçš„runnerçŠ¶æ€æ˜¯é»‘è‰²çš„ï¼Œç­‰ä¼šå°±ä¼šå˜æˆç»¿è‰²

![](https://images.591wsh.com/2021/10/14/thumb_1634195127162.png)



 åˆ°æ­¤ä¸ºæ­¢ï¼Œrunnerå·²ç»å‡†å¤‡å°±ç»ªï¼Œä»–ä¼šæ‰§è¡Œæˆ‘ä»¬é¡¹ç›®ä¸­çš„`.gitlab-ci.yml`æ–‡ä»¶ä¸­çš„é…ç½®

## ç¼–å†™.gitlab-ci.yml

> å…·ä½“ç¼–å†™è¿‡ç¨‹è¯·æŸ¥çœ‹å®˜æ–¹æ•™ç¨‹

**psï¼šæ³¨æ„ä¸€ç‚¹ï¼Œçº¿ä¸Šé™æ€æ–‡ä»¶æœ€å¥½ä¸è¦å‘½åä¸ºdistï¼ŒCIè„šæœ¬ä¸­distä¸ºä¸­è½¬ç«™æ–‡ä»¶å¤¹ï¼Œå‘½åä¸ºdistä¼šå‡ºç°é—®é¢˜**

```bash
stages: # åˆ†æ®µ
  - install
  - build
  - deploy

cache: # ç¼“å­˜
  paths:
    - node_modules
    - admin

install-job:
  stage: install
  only:
    - prod-pre
  script:
    - echo "å¼€å§‹installğŸ”¥ğŸ”¥ğŸ”¥"
    - npm install
    - echo "å®ŒæˆinstallğŸ”¥ğŸ”¥ğŸ”¥"

build-job:
  stage: build
  only:
    - prod-pre
  script:
    - echo "å¼€å§‹ä»£ç æ‰“åŒ…ğŸ’ªğŸ’ªğŸ’ª"
    - npm run build
    - echo "å®Œæˆä»£ç æ‰“åŒ…ğŸ’ªğŸ’ªğŸ’ª"

deploy-job:
  stage: deploy
  only:
    - prod-pre
  before_script:
    - echo "å‘å°„åˆ°ç›®æ ‡æœåŠ¡å™¨âœ¨âœ¨âœ¨"
  script:
    - sshpass -p $PASSWORD scp -o StrictHostKeyChecking=no -r ./dist $USERNAME@$HOST:$UPLOADDIR/   # å°†æ‰“åŒ…å®Œæˆçš„æ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡æœåŠ¡å™¨
    - sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$HOST rm -rf $UPLOADDIR/xxxx # åˆ é™¤åŸæœ‰æ–‡ä»¶
    - sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$HOST mv $UPLOADDIR/dist $UPLOADDIR/xxxx # å°†ç›®æ ‡æ–‡ä»¶æ”¹ä¸ºæœåŠ¡ç«¯çœŸæ­£æ–‡ä»¶
  after_script:
    - echo "å®Œæˆæ›´æ–°ğŸ‘ğŸ‘ğŸ‘"

```



åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†æ‰§è¡Œçš„åˆ†æ”¯ï¼Œå½“æˆ‘ä»¬åœ¨prod-preåˆ†æ”¯ä¸Šæäº¤ä»£ç çš„æ—¶å€™ï¼Œè„šæœ¬å°±ä¼š**è‡ªåŠ¨æ‰§è¡Œ**

- installé¡¹ç›®ä¾èµ–
- buildé¡¹ç›®
- å‘å°„åˆ°ç›®æ ‡æœåŠ¡å™¨

![image-20211014154621451](https://images.591wsh.com/2021/10/14/thumb_1634197592199.png)



è¿™æ ·å°±å®Œæˆæˆ‘ä»¬é¡¹ç›®çš„è‡ªåŠ¨åŒ–éƒ¨ç½²

##  CIè„šæœ¬çš„ä¼˜åŒ–

### ä¼˜åŒ–è‡ªåŠ¨åŒ–éƒ¨ç½²é€Ÿåº¦

ä¸Šé¢æˆ‘ä»¬å®Œæˆäº†ä¸€ä¸ªç®€å•çš„æµæ°´çº¿ï¼Œä»–å¯ä»¥å®Œæˆ install build delayï¼Œå·²ç»æ»¡è¶³äº†åŸºæœ¬è¦æ±‚ï¼Œä½†æ˜¯è¿˜å­˜åœ¨ä¸€äº›å°é—®é¢˜

- æµæ°´çº¿ä»»åŠ¡æ—¶é—´è¿‡é•¿
- é¢‘ç¹installå­˜åœ¨å¤±è´¥çš„æ¦‚ç‡

æˆ‘ä»¬éœ€è¦ä¼˜åŒ–æˆ‘ä»¬çš„CIï¼Œè®©é€Ÿåº¦æ›´å¿«æ›´åŠ ç¨³å®š

buildç¯èŠ‚ä¸delayç¯èŠ‚æ²¡æœ‰å¤ªå¤§çš„æ“ä½œç©ºé—´ï¼Œå¹¶ä¸”å¤§éƒ¨åˆ†çš„æ—¶é—´éƒ½èŠ±åœ¨installç¯èŠ‚ï¼Œæˆ‘ä»¬å¯ç”¨äº†gitlabçš„cacheï¼Œå®é™…ä¸Šå¹¶ä¸éœ€è¦æ¯æ¬¡éƒ½æ‰“åŒ…ï¼Œé’ˆå¯¹è¿™ä¸ªæ€è·¯æˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬jobä¸­çš„ **install**ï¼Œåœ¨jobä¸­å¢åŠ å½“å‰æ˜¯å¦å­˜åœ¨**node_modules/**çš„åˆ¤æ–­

```yaml
install-job:
  stage: install
  only:
    refs:
      - prod-pre
  script:
    - echo "å¼€å§‹installğŸ”¥ğŸ”¥ğŸ”¥"
    - if [ ! -d "./node_modules/" ];then   npm install;   else   echo "ç¼“å­˜å­˜åœ¨,è·³è¿‡install"; fi
    - echo "å®ŒæˆinstallğŸ”¥ğŸ”¥ğŸ”¥"
```

 		è¿™æ ·å­˜åœ¨ç¼“å­˜çš„æ—¶å€™å°±ä¼šè·³è¿‡installé˜¶æ®µï¼Œä½†æ˜¯è¿™æ ·è¿˜å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†ä¾èµ–ï¼Œä½†æ˜¯gitlabé‡Œé¢ç¼“å­˜è¿˜åœ¨ï¼Œå¿…ç„¶ä¼šå‡ºç°æ‰“åŒ…å¼‚å¸¸çš„æƒ…å†µï¼Œé’ˆå¯¹package.jsonå‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬å†å¢åŠ ä¸€ä¸ªjobï¼Œç›‘å¬package.json æ˜¯å¦å‘ç”Ÿå˜åŒ–

### é™æ€æ•°æ®æå–ä¸ºå˜é‡

> å‡å¦‚å­˜åœ¨å¤šä¸ªé¡¹ç›®ï¼Œä½¿ç”¨æœ¬è„šæœ¬åªéœ€è¦ä¿®æ”¹æ­¤å¤„çš„variableså³å¯ï¼Œä¸éœ€è¦æ”¹scriptéƒ¨åˆ†

```yaml
variables:
  BUILDDIR: dist # æ‰“åŒ…æ–‡ä»¶å
  PRODDIR: dist # çº¿ä¸Šæ–‡ä»¶å
  BACKUPDIR: dist_back # å¤‡ä»½æ–‡ä»¶å¤¹
```



### å¢åŠ å¤‡ä»½åŠŸèƒ½

- åˆ é™¤åŸæœ‰å¤‡ä»½æ–‡ä»¶(ä»…åœ¨ç”Ÿäº§ç¯å¢ƒ)
- åˆ é™¤åŸæœ‰æ–‡ä»¶ å¤‡ä»½åŸæœ¬çš„ä»£ç (ä»…åœ¨ç”Ÿäº§ç¯å¢ƒ)
- å°†æ‰“åŒ…å®Œæˆçš„æ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡æœåŠ¡å™¨
- å°†ç›®æ ‡æ–‡ä»¶æ”¹ä¸ºæœåŠ¡ç«¯çœŸæ­£æ–‡ä»¶

## .gitlab-ci.ymlï¼ˆæ­£å¼ç‰ˆæœ¬ï¼‰

> æŒ‡å®šäº†prodåˆ†æ”¯ï¼Œæ ¹æ®å®é™…é¡¹ç›®è¿›è¡Œä¿®æ”¹

```yaml
stages: # åˆ†æ®µ
  - repInstall
  - install
  - build
  - deploy

variables:
  BUILDDIR: dist # æ‰“åŒ…æ–‡ä»¶å
  PRODDIR: dist # çº¿ä¸Šæ–‡ä»¶å
  BACKUPDIR: dist_back # å¤‡ä»½æ–‡ä»¶å¤¹

cache: # ç¼“å­˜
  paths:
    - node_modules
    - dist

repInstall-job:
  stage: repInstall
  only:
    refs:
      - prod
    changes:
      - package.json
  script:
    - echo "ä¾èµ–å‘ç”Ÿå˜åŒ–,å¼€å§‹installğŸ”¥ğŸ”¥ğŸ”¥"
    - cnpm install
    - echo "å®ŒæˆinstallğŸ”¥ğŸ”¥ğŸ”¥"

install-job:
  stage: install
  only:
    refs:
      - prod
  script:
    - echo "å¼€å§‹installğŸ”¥ğŸ”¥ğŸ”¥"
    - if [ ! -d "./node_modules/" ];then   npm install;   else   echo "ç¼“å­˜å­˜åœ¨,è·³è¿‡install"; fi
    - echo "å®ŒæˆinstallğŸ”¥ğŸ”¥ğŸ”¥"

build-job:
  stage: build
  only:
    - prod
  script:
    - echo "å¼€å§‹ä»£ç æ‰“åŒ…ğŸ’ªğŸ’ªğŸ’ª"
    - npm run build
    - echo "å®Œæˆä»£ç æ‰“åŒ…ğŸ’ªğŸ’ªğŸ’ª"

deploy-job:
  stage: deploy
  only:
    - prod
  before_script:
    - echo "å‘å°„åˆ°ç›®æ ‡æœåŠ¡å™¨âœ¨âœ¨âœ¨"
  script:
    - echo "å‘å°„åˆ°ç›®æ ‡æœåŠ¡å™¨âœ¨âœ¨âœ¨"
    - sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$HOST rm -rf $UPLOADDIR/backup/$BACKUPDIR # åˆ é™¤åŸæœ‰å¤‡ä»½æ–‡ä»¶(ä»…åœ¨ç”Ÿäº§ç¯å¢ƒ)
    - sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$HOST mv $UPLOADDIR/$PRODDIR/ $UPLOADDIR/backup/$BACKUPDIR/ # åˆ é™¤åŸæœ‰æ–‡ä»¶ å¤‡ä»½åŸæœ¬çš„ä»£ç (ä»…åœ¨ç”Ÿäº§ç¯å¢ƒ)
    - sshpass -p $PASSWORD scp -o StrictHostKeyChecking=no -r ./$BUILDDIR/. $USERNAME@$HOST:$UPLOADDIR/dist # å°†æ‰“åŒ…å®Œæˆçš„æ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡æœåŠ¡å™¨
    - sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$HOST mv $UPLOADDIR/dist $UPLOADDIR/$PRODDIR # å°†ç›®æ ‡æ–‡ä»¶æ”¹ä¸ºæœåŠ¡ç«¯çœŸæ­£æ–‡ä»¶
    - echo "å®Œæˆæ›´æ–°ğŸ‘ğŸ‘ğŸ‘"
  after_script:
    - echo "å®Œæˆæ›´æ–°ğŸ‘ğŸ‘ğŸ‘"

```





## .gitlab-ci.ymlï¼ˆç®€åŒ–ï¼‰

> æŒ‡å®šäº†prod-preåˆ†æ”¯ï¼Œæ ¹æ®å®é™…é¡¹ç›®è¿›è¡Œä¿®æ”¹

```yaml
stages: # åˆ†æ®µ
  - preInstall
  - install
  - build
  - deploy

variables:
  BUILDDIR: dist # æ‰“åŒ…æ–‡ä»¶å
  PRODDIR: dist_test # çº¿ä¸Šæ–‡ä»¶å

cache: # ç¼“å­˜
  paths:
    - node_modules
    - dist

preInstall-job:
  stage: preInstall
  only:
    refs:
      - prod-pre
    changes:
      - package.json
  script:
    - echo "ä¾èµ–å‘ç”Ÿå˜åŒ–,å¼€å§‹installğŸ”¥ğŸ”¥ğŸ”¥"
    - cnpm install
    - echo "å®ŒæˆinstallğŸ”¥ğŸ”¥ğŸ”¥"

install-job:
  stage: install
  only:
    refs:
      - prod-pre
  script:
    - echo "å¼€å§‹installğŸ”¥ğŸ”¥ğŸ”¥"
    - if [ ! -d "./node_modules/" ];then   npm install;   else   echo "ç¼“å­˜å­˜åœ¨,è·³è¿‡install"; fi
    - echo "å®ŒæˆinstallğŸ”¥ğŸ”¥ğŸ”¥"

build-job:
  stage: build
  only:
    - prod-pre
  script:
    - echo "å¼€å§‹ä»£ç æ‰“åŒ…ğŸ’ªğŸ’ªğŸ’ª"
    - npm run build
    - echo "å®Œæˆä»£ç æ‰“åŒ…ğŸ’ªğŸ’ªğŸ’ª"

deploy-job:
  stage: deploy
  only:
    - prod-pre
  before_script:
    - echo "å‘å°„åˆ°ç›®æ ‡æœåŠ¡å™¨âœ¨âœ¨âœ¨"
  script:
    - sshpass -p $PASSWORD scp -o StrictHostKeyChecking=no -r ./$BUILDDIR/. $USERNAME@$HOST:$UPLOADDIR/dist/ # å°†æ‰“åŒ…å®Œæˆçš„æ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡æœåŠ¡å™¨
    - sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$HOST rm -rf $UPLOADDIR/$PRODDIR # åˆ é™¤åŸæœ‰æ–‡ä»¶
    - sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$HOST mv $UPLOADDIR/dist $UPLOADDIR/$PRODDIR # å°†ç›®æ ‡æ–‡ä»¶æ”¹ä¸ºæœåŠ¡ç«¯çœŸæ­£æ–‡ä»¶
  after_script:
    - echo "å®Œæˆæ›´æ–°ğŸ‘ğŸ‘ğŸ‘"
```



## ä»£ç åœ°å€ï¼š

[github](https://github.com/vkcyan/code-fragment/tree/master/gitlab%20CI)



## ç»“è¯­

â€‹		é™¤äº†ä½¿ç”¨gitlabCI/CDæ¥å®Œæˆè‡ªåŠ¨åŒ–éƒ¨ç½²ä¹‹å¤–ä¹Ÿå¯ä»¥ä½¿ç”¨Jenkins+webHookæ¥å®Œæˆï¼Œæ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœè¿™ä¸¤ç§æ–¹æ¡ˆå¯¹ä½ ï¼Œæˆ–è€…ä½ çš„å…¬å¸æ¥è¯´éƒ½æ¯”è¾ƒå¤æ‚ï¼Œé‚£ä¹ˆæˆ‘å»ºè®®è¯•è¯•[è½»é‡åŒ–æ›´æ–°æ–¹æ¡ˆ](https://juejin.cn/post/7020322286565589029)ï¼Œæˆ‘ä»¬ä¹Ÿåœ¨å®é™…é¡¹ç›®ä¸Šä½¿ç”¨è¿‡å¾ˆä¹…ï¼Œå¯ä»¥ç¡®ä¿ä¸ä¼šå‡ºç°ç¨³å®šæ€§ï¼Œæ˜¯å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„



å¦‚æœä½¿ç”¨ä¸­é‡åˆ°äº†ä»€ä¹ˆé—®é¢˜ï¼Œè¯·åˆ°QQç¾¤ 530496237ï¼Œä¸€èµ·å¹å¹æ°´

ä¹Ÿå¯ä»¥æ·»åŠ æˆ‘çš„å¾®ä¿¡ï¼šcarpediem-rollinï¼ŒåŠ å…¥å¾®ä¿¡ç¾¤